<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Coger Agri Admin Dashboard</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- jsPDF libraries for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
  /* CSS Variables and Themes */
  :root {
    --green: #2d5016;
    --light-green: #4a7c2c;
    --sage: #7fb069;
    --brown: #8b7355;
    --yellow: #f4a259;
    --bg: #f8f9f0;
    --white: #fff;
    --dark: #2c3e1f;
    --red: #d9534f;
    --orange: #f0ad4e;
    --success: #5cb85c;
  }
  body {
    font-family: Arial, sans-serif;
    background: var(--bg);
    color: var(--dark);
    margin: 0;
    display: flex;
    min-height: 100vh;
  }
  body.dark-theme {
    --green: #90ee90;
    --light-green: #6bbf6b;
    --sage: #a3d9a5;
    --brown: #5a4a3b;
    --yellow: #f0e68c;
    --bg: #121212;
    --white: #eeeeee;
    --dark: #e0e0e0;
    --red: #f08080;
    --orange: #f4a259;
    --success: #4caf50;
    background: var(--bg);
    color: var(--white);
  }
  /* Sidebar */
  .sidebar {
    width: 260px;
    background: linear-gradient(180deg, var(--green), var(--light-green));
    color: white;
    position: fixed;
    top: 0; left: 0;
    height: 100vh;
    overflow-y: auto;
    padding-top: 20px;
    box-sizing: border-box;
  }
  .sidebar .logo {
    font-size: 26px;
    font-weight: bold;
    padding: 20px 0;
    text-align: center;
    user-select: none;
    border-bottom: 1px solid rgba(255,255,255,0.2);
  }
  .menu-item {
    padding: 15px 25px;
    cursor: pointer;
    border-left: 4px solid transparent;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.3s;
    user-select: none;
  }
  .menu-item:hover,
  .menu-item.active {
    background: rgba(255, 255, 255, 0.1);
    border-left-color: var(--yellow);
  }
  /* Main content */
  .main {
    margin-left: 260px;
    padding: 20px 30px;
    flex: 1;
    overflow-y: auto;
    background: var(--bg);
    min-height: 100vh;
    box-sizing: border-box;
  }
  /* Top bar */
  .top-bar {
    background: white;
    padding: 15px 25px;
    border-radius: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    user-select: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    margin-bottom: 20px;
  }
  body.dark-theme .top-bar {
    background: #222;
    box-shadow: 0 2px 12px rgba(255,255,255,0.1);
    color: var(--white);
  }
  /* Buttons */
  .btn-primary, .btn-warn, .btn-success, .btn-danger {
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    color: white;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  .btn-primary { background-color: var(--light-green);}
  .btn-primary:hover { background-color: var(--green);}
  .btn-success { background-color: var(--success);}
  .btn-danger { background-color: var(--red);}
  .btn-warn { background-color: var(--orange);}
  .btn-warn:hover { background-color: #cf8c46; }
  /* Toast */
  .toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--green);
    color: white;
    padding: 15px 25px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease-in-out;
    z-index: 10000;
  }
  .toast.show {
    opacity: 1;
    pointer-events: auto;
  }
  /* General section container */
  .section {
    display: none;
  }
  .section.active {
    display: block;
    animation: fadeIn 0.3s ease;
  }
  /* Tables */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  table th, table td {
    border: 1px solid #ccc;
    padding: 8px 10px;
    text-align: left;
    vertical-align: middle;
  }
  body.dark-theme table th,
  body.dark-theme table td {
    border-color: #555;
  }
  /* Form Controls */
  .search, select, input[type="text"], input[type="number"], input[type="date"], textarea {
    padding: 8px 12px;
    border: 2px solid #e0e0e0;
    border-radius: 6px;
    font-size: 14px;
    box-sizing: border-box;
  }
  .search:focus, select:focus, input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, textarea:focus {
    outline: none;
    border-color: var(--sage);
  }
  /* Responsive */
  @media (max-width: 768px) {
    .main {
      margin-left: 0;
      width: 100%;
    }
    .sidebar {
      width: 100%;
      height:auto;
      position: relative;
    }
    .top-bar {
      flex-direction: column;
      gap: 10px;
    }
  }
  @keyframes fadeIn {
    from {opacity: 0;}
    to {opacity: 1;}
  }
</style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar" role="navigation" aria-label="Primary sidebar">
  <div class="logo">ðŸŒ¾ Coger Agri</div>
  <div class="menu-item active" data-section="dashboard" tabindex="0">ðŸ“Š Dashboard</div>
  <div class="menu-item" data-section="products" tabindex="0">ðŸ“¦ Products</div>
  <div class="menu-item" data-section="orders" tabindex="0">ðŸ›’ Orders</div>
  <div class="menu-item" data-section="customers" tabindex="0">ðŸ‘¥ Customers</div>
  <div class="menu-item" data-section="analytics" tabindex="0">ðŸ“ˆ Analytics</div>
  <div class="menu-item" data-section="finances" tabindex="0">ðŸ’° Finances</div>
</div>

<div class="main" role="main" tabindex="0">

  <div class="top-bar">
    <div class="title">Admin Dashboard</div>
    <div>
      Admin User ðŸŒ±
      <button id="themeToggleBtn" class="btn-warn" aria-pressed="false" aria-label="Toggle dark mode">ðŸŒ™ Dark Mode</button>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="section active" tabindex="0">
    <h2>Welcome to Coger Agri Admin Dashboard</h2>
    <p>This is your dashboard overview.</p>
    <ul>
      <li>Total Products: <span id="dashboardTotalProducts"></span></li>
      <li>Total Orders: <span id="dashboardTotalOrders"></span></li>
      <li>Total Customers: <span id="dashboardTotalCustomers"></span></li>
      <li>Monthly Sales (â‚¹): <span id="dashboardMonthlySales"></span></li>
    </ul>
  </div>

  <!-- Products -->
  <div id="products" class="section" tabindex="0">
    <h2>Product Management</h2>
    <input type="text" id="productSearch" placeholder="Search products..." class="search" />
    <table id="productsTable">
      <thead>
        <tr><th>Image</th><th>Name</th><th>Category</th><th>Price</th><th>Stock</th></tr>
      </thead>
      <tbody id="productsList"></tbody>
    </table>
  </div>

  <!-- Orders -->
  <div id="orders" class="section" tabindex="0">
    <h2>Order Management</h2>
    <input type="text" id="orderSearch" placeholder="Search orders..." class="search" />
    <table id="ordersTable">
      <thead>
        <tr><th>Order ID</th><th>Customer</th><th>Total</th><th>Status</th></tr>
      </thead>
      <tbody id="ordersList"></tbody>
    </table>
  </div>

  <!-- Customers -->
  <div id="customers" class="section" tabindex="0">
    <h2>Customer Management</h2>
    <input type="text" id="customerSearch" placeholder="Search customers..." class="search" />
    <table id="customersTable">
      <thead>
        <tr><th>Name</th><th>Email</th><th>Orders</th><th>Total Spent</th></tr>
      </thead>
      <tbody id="customersList"></tbody>
    </table>
  </div>

  <!-- Analytics -->
  <div id="analytics" class="section" tabindex="0">
    <h2>Sales Analytics</h2>
    <canvas id="salesChart" height="150"></canvas>
  </div>

  <!-- Finances -->
  <div id="finances" class="section" tabindex="0" style="outline:none;">
    <h2>Financial Overview</h2>

    <!-- User Role Selection -->
    <div style="margin-bottom: 15px;">
      <label for="roleSelect">Current User Role: </label>
      <select id="roleSelect" style="padding:6px; min-width: 150px;">
        <option value="admin" selected>Admin</option>
        <option value="accountant">Accountant</option>
        <option value="viewer">Viewer</option>
      </select>
    </div>

    <!-- Summary Widgets -->
    <div id="financeWidgets" style="display:flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap;">
      <div class="finance-widget" style="flex:1; min-width:150px; background:var(--sage);color:#fff; padding:15px; border-radius:10px;">
        <strong>Total Expenses:</strong> <span id="widgetTotalExpenses">â‚¹0.00</span>
      </div>
      <div class="finance-widget" style="flex:1; min-width:150px; background:var(--light-green);color:#fff; padding:15px; border-radius:10px;">
        <strong>Total Returns:</strong> <span id="widgetTotalReturns">â‚¹0.00</span>
      </div>
      <div class="finance-widget" style="flex:1; min-width:150px; background:var(--yellow);color:#000; padding:15px; border-radius:10px;">
        <strong>Profit / Loss:</strong> <span id="widgetProfitLoss">â‚¹0.00</span>
      </div>
      <div class="finance-widget" style="flex:1; min-width:150px; background:var(--brown);color:#fff; padding:15px; border-radius:10px;">
        <strong>ROI %:</strong> <span id="widgetROI">0.00%</span>
      </div>
    </div>

    <!-- Profit/Loss Button -->
    <div style="margin-bottom: 15px;">
      <button id="profitLossBtn" class="btn-primary" style="font-size:16px; padding:10px 30px; width: fit-content;">
        Profit/Loss: â‚¹0.00
      </button>
    </div>

    <!-- Filters & Currency -->
    <div style="display:flex; align-items:center; gap:20px; margin-bottom: 10px; flex-wrap: wrap;">
      <label for="monthFilter">Select Month: </label>
      <input type="month" id="monthFilter" />

      <label for="currencySelect" style="white-space: nowrap;">Currency: </label>
      <select id="currencySelect" style="padding:6px;">
        <option value="INR" selected>â‚¹ INR</option>
        <option value="USD">$ USD</option>
        <option value="EUR">â‚¬ EUR</option>
        <option value="GBP">Â£ GBP</option>
      </select>
    </div>

    <!-- Budget Limits -->
    <div style="margin-bottom: 15px;">
      <h3>Budget Limits (per category)</h3>
      <div id="budgetLimitsContainer" style="display:flex; flex-wrap: wrap; gap: 10px;"></div>
    </div>

    <!-- Add Expense Form -->
    <div style="margin-bottom: 20px; border:1px solid var(--light-green); box-shadow: 0 2px 12px rgba(74,124,44,0.2); padding:20px; border-radius:16px; max-width:750px; background: var(--white); color: var(--dark);">
      <h3 style="margin-bottom: 15px; color: var(--green); font-weight: 700;">Add New Expense</h3>
      <form id="addExpenseForm" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); grid-gap: 16px; align-items: end;">
        <div>
          <label for="expenseDate" style="display:block; font-weight:600; margin-bottom:4px;">Date</label>
          <input type="date" id="expenseDate" required style="width:100%; padding:10px; border: 2px solid var(--sage); border-radius: 8px; font-size: 14px;" />
        </div>
        <div style="position:relative;">
          <label for="expenseCategory" style="display:block; font-weight:600; margin-bottom:4px;">Category</label>
          <input type="text" id="categorySearch" placeholder="Search categories..." style="width:100%; padding:8px 10px; border:2px solid var(--sage); border-radius:8px; font-size:14px; margin-bottom:6px;" autocomplete="off" />
          <select id="expenseCategory" required style="width:100%; padding:10px; border: 2px solid var(--sage); border-radius: 8px; font-size: 14px; cursor: pointer;">
            <option value="" disabled selected>Select Category</option>
            <optgroup label="Core Business">
              <option value="Processing">Processing</option>
              <option value="Labor">Labor</option>
              <option value="Maintenance">Maintenance</option>
            </optgroup>
            <optgroup label="Operations">
              <option value="Travel">Travel</option>
              <option value="Transport">Transport</option>
              <option value="Packaging">Packaging</option>
              <option value="Utilities">Utilities</option>
            </optgroup>
            <optgroup label="Marketing & Sales">
              <option value="Marketing">Marketing</option>
            </optgroup>
            <option value="Other">Other</option>
          </select>
        </div>
        <div>
          <label for="expenseAmount" style="display:block; font-weight:600; margin-bottom:4px;">Amount</label>
          <input type="number" id="expenseAmount" min="0" step="0.01" required style="width:100%; padding:10px; border: 2px solid var(--sage); border-radius: 8px; font-size: 14px;" placeholder="â‚¹0.00" />
        </div>
        <div style="grid-column: span 2;">
          <label for="expenseNotes" style="display:block; font-weight:600; margin-bottom:4px;">Notes</label>
          <input type="text" id="expenseNotes" placeholder="Optional notes (description, etc.)" style="width:100%; padding:10px; border: 2px solid var(--sage); border-radius: 8px; font-size: 14px;" />
        </div>
        <div style="display:flex; flex-direction: column; align-items: center;">
          <label for="recurringExpense" style="font-weight:600; margin-bottom:6px;">Recurring?</label>
          <input type="checkbox" id="recurringExpense" style="width: 20px; height: 20px;" />
        </div>
        <div>
          <label for="expenseAttachment" style="display:block; font-weight:600; margin-bottom:4px;">Receipt (Image)</label>
          <input type="file" id="expenseAttachment" accept="image/*" style="width:100%; padding:6px; border: 2px solid var(--sage); border-radius: 8px; font-size: 14px;"/>
        </div>
        <div style="display:flex; justify-content:flex-end; align-items:center;">
          <button type="submit" class="btn-primary" style="min-width: 120px; padding:12px 24px; font-weight: 700; font-size: 16px; border-radius: 8px;">Add Expense</button>
        </div>
      </form>
      <div id="attachmentPreviewContainer" style="margin-top:10px;"></div>
    </div>

    <!-- Expenses Table -->
    <table id="expenseTable" style="width:100%; margin-bottom:20px;">
      <thead>
        <tr>
          <th>Date</th>
          <th>Category</th>
          <th>Amount (â‚¹)</th>
          <th>Notes</th>
          <th>Recurring</th>
          <th>Receipt</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="expenseLogBody"></tbody>
    </table>

    <!-- Export Buttons -->
    <div style="margin-bottom:20px;">
      <button id="exportExpensesCSV" class="btn-primary">Export Expenses CSV</button>
      <button id="exportSummaryCSV" class="btn-primary" style="margin-left:10px;">Export Summary CSV</button>
      <button id="exportPDF" class="btn-primary" style="margin-left:10px;">Export PDF Report</button>
    </div>

    <!-- Charts -->
    <canvas id="expensesPieChart" height="200" style="margin-bottom: 30px;"></canvas>
    <canvas id="budgetBarChart" height="200"></canvas>

    <!-- Notifications -->
    <div id="financeNotification" role="alert" style="position: fixed; bottom: 20px; right: 20px; background: var(--yellow); color: black; padding: 12px 20px; border-radius: 10px; display:none; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index:10000;"></div>
  </div>

</div>

<script>
  // Core Data Samples
  const products = [
    { id: 1, name: "Organic Seeds", category: "Seeds", price: 29.99, stock: 150, imageUrl:"https://via.placeholder.com/50?text=Seeds" },
    { id: 2, name: "Bio Fertilizer", category: "Fertilizers", price: 45.5, stock: 8, imageUrl:"https://via.placeholder.com/50?text=Fertilizer" },
    { id: 3, name: "Garden Tools Set", category: "Tools", price: 89.99, stock: 45, imageUrl:"https://via.placeholder.com/50?text=Tools" }
  ];
  const orders = [
    { id: 101, customer: "John Doe", total: 125.5, status: "Pending" },
    { id: 102, customer: "Jane Smith", total: 299.99, status: "Shipped" },
    { id: 103, customer: "Bob Johnson", total: 75.0, status: "Delivered" },
  ];
  const customers = [
    { name: "John Doe", email: "john@example.com", orders: 3, spent: 450 },
    { name: "Jane Smith", email: "jane@example.com", orders: 5, spent: 890 },
  ];

  // Finance variables (initial sample)
  let expenseCategories = ["Processing", "Labor", "Maintenance", "Travel", "Transport", "Packaging", "Utilities", "Marketing", "Other"];
  let budgetLimits = { "Processing": 40000, "Labor": 30000, "Maintenance": 10000, "Travel": 20000, "Transport": 15000, "Packaging": 10000, "Utilities": 5000, "Marketing": 7000, "Other": 5000 };
  let expenses = [];
  let expenseIdCounter = 1;
  let totalReturns = 100000;
  let currencyRates = {INR: 1, USD:0.012, EUR:0.011, GBP:0.0097};
  let baseCurrency = "INR";
  let currentUserRole = "admin";
  let pieChart=null;
  let budgetBarChart=null;
  let attachmentBase64 = null;

  });

  // Theme toggle code
  const themeToggleBtn = document.getElementById('themeToggleBtn');
  function applyTheme(theme) {
    if (theme === "dark") {
      document.body.classList.add("dark-theme");
      themeToggleBtn.textContent = "â˜€ï¸ Light Mode";
      themeToggleBtn.setAttribute("aria-pressed", "true");
    } else {
      document.body.classList.remove("dark-theme");
      themeToggleBtn.textContent = "ðŸŒ™ Dark Mode";
      themeToggleBtn.setAttribute("aria-pressed", "false");
    }
    localStorage.setItem("preferredTheme", theme);
  }
  themeToggleBtn.addEventListener("click", () => {
    const currentTheme = localStorage.getItem("preferredTheme") || "light";
    const nextTheme = currentTheme === "dark" ? "light" : "dark";
    applyTheme(nextTheme);
  });

  // Load default theme on start
  window.addEventListener("482
                          ", () => {
    const storedTheme = localStorage.getItem("preferredTheme") || "light";
    applyTheme(storedTheme);
        document.querySelectorAll('.menu-item').forEach(item=>item.addEventListener('click',()=>{document.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('active'));document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));item.classList.add('active');const sectionId=item.getAttribute('data-section');document.getElementById(sectionId).classList.add('active');if(sectionId==='analytics')renderSalesChart();if(sectionId==='finances')updateFinances();}));
    loadProductsTable('');
    loadOrdersTable('');
    loadCustomersTable('');
    renderSalesChart();
    initializeFinanceUI();
    updateDashboardSummary();
  });

  // Dashboard summary update
  function updateDashboardSummary(){
    document.getElementById('dashboardTotalProducts').textContent = products.length;
    document.getElementById('dashboardTotalOrders').textContent = orders.length;
    document.getElementById('dashboardTotalCustomers').textContent = customers.length;
    const sales = orders.reduce((s,o)=>s+o.total,0);
    document.getElementById('dashboardMonthlySales').textContent = `â‚¹${sales.toFixed(2)}`;
  }

  // Loaders for tables with search
  function loadProductsTable(filter=''){
    const tbody = document.getElementById('productsList');
    tbody.innerHTML='';
    const filtered = products.filter(p => p.name.toLowerCase().includes(filter.toLowerCase()));
    filtered.forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML=`
        <td><img src="${p.imageUrl}" alt="${p.name}" style="width:50px; border-radius:6px;"></td>
        <td>${p.name}</td><td>${p.category}</td><td>â‚¹${p.price.toFixed(2)}</td><td>${p.stock}</td>
      `;
      tbody.appendChild(tr);
    });
  }
  function loadOrdersTable(filter=''){
    const tbody = document.getElementById('ordersList');
    tbody.innerHTML = '';
    const filtered = orders.filter(o=> o.customer.toLowerCase().includes(filter.toLowerCase()));
    filtered.forEach(o => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${o.id}</td><td>${o.customer}</td><td>â‚¹${o.total.toFixed(2)}</td><td>${o.status}</td>`;
      tbody.appendChild(tr);
    });
  }
  function loadCustomersTable(filter=''){
    const tbody = document.getElementById('customersList');
    tbody.innerHTML='';
    const filtered=customers.filter(c=> c.name.toLowerCase().includes(filter.toLowerCase()));
    filtered.forEach(c => {
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${c.name}</td><td>${c.email}</td><td>${c.orders}</td><td>â‚¹${c.spent}</td>`;
      tbody.appendChild(tr);
    });
  }

  document.getElementById('productSearch').addEventListener('input', e => loadProductsTable(e.target.value));
  document.getElementById('orderSearch').addEventListener('input', e => loadOrdersTable(e.target.value));
  document.getElementById('customerSearch').addEventListener('input', e => loadCustomersTable(e.target.value));

  // Sales Chart setup
  let salesChartInstance;
  function renderSalesChart() {
    const ctx=document.getElementById('salesChart').getContext('2d');
    if(salesChartInstance) salesChartInstance.destroy();
    salesChartInstance=new Chart(ctx,{
      type:'line',
      data:{
        labels:['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],
        datasets:[{
          label:'Sales',
          data:[1200,1900,1500,2200,1700,1400,2100],
          borderColor:'#4a7c2c',
          backgroundColor:'rgba(74,124,44,0.3)',
          fill:true,
          tension:0.2
        }]
      },
      options:{responsive:true,scales:{y:{beginAtZero:true}}}
    });
  }

  /*--------------- Finances Module ---------------*/

  // Initialize finance UI components and handlers
  function initializeFinanceUI() {
    populateCategoryDropdown();
    populateBudgetInputs();
    setupFinanceEventListeners();
    setDefaultMonthFilter();
  }

  // Category dropdown with search
  const categorySearchInput = document.getElementById('categorySearch');
  const expenseCategorySelect = document.getElementById('expenseCategory');

  function populateCategoryDropdown(){
    // Clear existing (except placeholder)
    const placeholder = expenseCategorySelect.querySelector('option[value=""]');
    expenseCategorySelect.innerHTML = '';
    expenseCategorySelect.appendChild(placeholder);
    expenseCategories.forEach(c=>{
      const opt=document.createElement('option');
      opt.value=c;
      opt.textContent=c;
      expenseCategorySelect.appendChild(opt);
    });
  }

  // Filter categories dynamically as user types
  categorySearchInput.addEventListener('input', () => {
    const filter = categorySearchInput.value.toLowerCase();
    Array.from(expenseCategorySelect.options).forEach(opt => {
      if(opt.value === '') return; // keep placeholder visible
      opt.style.display = opt.text.toLowerCase().includes(filter) ? 'block' : 'none';
    });
    // Reset selected option if currently hidden
    if(expenseCategorySelect.selectedIndex >= 0){
      const selOpt = expenseCategorySelect.options[expenseCategorySelect.selectedIndex];
      if(selOpt && selOpt.style.display === 'none') expenseCategorySelect.selectedIndex = 0;
    }
  });

  // Populate budget limits inputs
  function populateBudgetInputs(){
    const container=document.getElementById('budgetLimitsContainer');
    container.innerHTML='';
    expenseCategories.forEach(cat=>{
      const div=document.createElement('div');
      div.style.minWidth = '140px';
      div.style.backgroundColor= 'var(--sage)';
      div.style.color = '#000';
      div.style.padding = '10px';
      div.style.borderRadius = '8px';
      div.style.textAlign = 'center';
      div.style.userSelect = 'none';

      const label=document.createElement('div');
      label.textContent = cat;
      label.style.fontWeight = '600';
      label.style.marginBottom = '8px';

      const input=document.createElement('input');
      input.type='number';
      input.min='0';
      input.value = budgetLimits[cat] || 0;
      input.dataset.cat = cat;
      input.style.width='100%';
      input.style.padding = '6px';
      input.style.fontSize = '14px';
      input.style.textAlign = 'center';

      input.addEventListener('input', e => {
        const val = parseFloat(e.target.value);
        if(!isNaN(val) && val>=0) {
          budgetLimits[e.target.dataset.cat] = val;
          updateFinances();
        }
      });

      div.appendChild(label);
      div.appendChild(input);
      container.appendChild(div);
    });
  }

  // Set current month filter control to current month
  function setDefaultMonthFilter(){
    const monthFilter = document.getElementById('monthFilter');
    const today = new Date();
    monthFilter.value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
    monthFilter.addEventListener('change', updateFinances);
  }

  // Event handlers for finances
  function setupFinanceEventListeners(){
    // Role selector
    document.getElementById('roleSelect').addEventListener('change', e => {
      currentUserRole = e.target.value;
      updateFinances();
    });
    // Currency selector
    document.getElementById('currencySelect').addEventListener('change', e => {
      baseCurrency = e.target.value;
      updateFinances();
    });
    // Total returns input handler
    const totalReturnsInput = document.getElementById('widgetTotalReturns');
    // We will allow returns updates via prompt on clicking the widget for simplicity
    totalReturnsInput.parentElement.addEventListener('click', () => {
      if(currentUserRole === 'viewer') return;
      const val = prompt('Enter total returns amount:', totalReturns.toString());
      if(val !== null){
        const num = parseFloat(val);
        if(!isNaN(num) && num >=0){
          totalReturns = num;
          updateFinances();
          showToast('Total returns updated');
        }
      }
    });

    // Add expense form submission
    document.getElementById('addExpenseForm').addEventListener('submit', e => {
      e.preventDefault();
      if(currentUserRole === 'viewer'){
        alert('You do not have permission to add expenses.');
        return;
      }
      addExpenseFromForm();
    });

    // Expense attachment preview
    const attInput = document.getElementById('expenseAttachment');
    const attPreview = document.getElementById('attachmentPreviewContainer');
    attInput.addEventListener('change', () => {
      attPreview.innerHTML = '';
      attachmentBase64 = null;
      if(attInput.files.length >0){
        const file = attInput.files[0];
        const fr = new FileReader();
        fr.onload = e => {
          attachmentBase64 = e.target.result;
          const img = document.createElement('img');
          img.src = attachmentBase64;
          img.alt = 'Receipt Preview';
          img.style.maxHeight = '120px';
          img.style.borderRadius = '8px';
          attPreview.appendChild(img);
        };
        fr.readAsDataURL(file);
      }
    });

    // Export buttons
    document.getElementById('exportExpensesCSV').addEventListener('click', exportExpensesCSV);
    document.getElementById('exportSummaryCSV').addEventListener('click', exportSummaryCSV);
    document.getElementById('exportPDF').addEventListener('click', exportPDFReport);
  }

  // Add expense from form inputs
  function addExpenseFromForm(){
    const date= document.getElementById('expenseDate').value;
    const category= document.getElementById('expenseCategory').value;
    const amount = parseFloat(document.getElementById('expenseAmount').value);
    const notes = document.getElementById('expenseNotes').value.trim();
    const recurring = document.getElementById('recurringExpense').checked;

    if(!date || !category || isNaN(amount) || amount<=0){
      alert('Please enter all required fields correctly.');
      return;
    }
    expenses.push({
      id: expenseIdCounter++,
      date,
      category,
      amount,
      notes,
      recurring,
      attachment: attachmentBase64
    });

    // Reset form and attachment preview
    document.getElementById('addExpenseForm').reset();
    document.getElementById('attachmentPreviewContainer').innerHTML = '';
    attachmentBase64 = null;

    updateFinances();
    showToast('Expense added successfully.');
  }

  // Toast notification helper
  let toastTimeout=null;
  function showToast(msg, duration=3000){
    const toast = document.createElement('div');
    toast.className = 'toast show';
    toast.textContent = msg;
    document.body.appendChild(toast);
    if(toastTimeout) clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => {
      toast.classList.remove('show');
      document.body.removeChild(toast);
    }, duration);
  }

  // Format number to currency string currency-aware
  function formatCurrency(amount, currency){
    const symbols = {INR:'â‚¹', USD:'$', EUR:'â‚¬', GBP:'Â£'};
    return symbols[currency] + amount.toFixed(2);
  }

  // Update all finance UI elements including widgets, tables, charts
  function updateFinances(){
    const rate = currencyRates[baseCurrency]||1;
    const monthFilter = document.getElementById('monthFilter').value;
    let filteredExpenses = monthFilter ?
      expenses.filter(e=>e.date.startsWith(monthFilter)) : expenses;
    const totalExpenses = filteredExpenses.reduce((a,b)=>a+b.amount, 0);
    document.getElementById('widgetTotalExpenses').textContent = formatCurrency(totalExpenses*rate, baseCurrency);
    document.getElementById('widgetTotalReturns').textContent = formatCurrency(totalReturns*rate, baseCurrency);
    const profitLoss = totalReturns - totalExpenses;
    document.getElementById('widgetProfitLoss').textContent = formatCurrency(profitLoss*rate, baseCurrency);
    document.getElementById('widgetROI').textContent = totalReturns ? ((profitLoss/totalReturns)*100).toFixed(2) + '%' : '0.00%';
    const profitLossBtn = document.getElementById('profitLossBtn');
    profitLossBtn.textContent = `Profit/Loss: ` + formatCurrency(profitLoss*rate, baseCurrency);
    if(profitLoss >=0){
      profitLossBtn.style.backgroundColor = 'var(--success)';
      profitLossBtn.style.color = 'white';
    } else {
      profitLossBtn.style.backgroundColor = 'var(--red)';
      profitLossBtn.style.color = 'white';
    }
    renderExpensesTable(filteredExpenses, rate);
    renderPieChart(filteredExpenses, rate);
    renderBudgetBarChart(filteredExpenses, rate);
    adjustUIForRole();
    checkBudgetAlerts(filteredExpenses, rate);
  }

  // Render expenses table
  function renderExpensesTable(expList, rate){
    const tbody = document.getElementById('expenseLogBody');
    tbody.innerHTML='';
    expList.forEach(e=>{
      let receiptLink = e.attachment ? `<a href="${e.attachment}" target="_blank" style="color:var(--green);">View</a>` : 'â€”';
      let canEdit = currentUserRole==='admin' || currentUserRole==='accountant';
      let delBtn = canEdit ? `<button class="btn-danger" style="font-size:12px; padding:4px 8px;" onclick="deleteExpense(${e.id})">Delete</button>` : '';
      let tr = document.createElement('tr');
      tr.innerHTML=`
        <td>${e.date}</td>
        <td>${e.category}</td>
        <td>${formatCurrency(e.amount*rate, baseCurrency)}</td>
        <td>${e.notes}</td>
        <td>${e.recurring ? 'Yes' : 'No'}</td>
        <td style="text-align:center;">${receiptLink}</td>
        <td style="text-align:center;">${delBtn}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Delete Expense by ID
  function deleteExpense(id){
    if(confirm('Delete this expense?')){
      expenses = expenses.filter(e=> e.id!==id);
      updateFinances();
      showToast('Expense deleted.');
    }
  }

  // Adjust UI controls based on role
  function adjustUIForRole(){
    const isEditable = (currentUserRole==='admin' || currentUserRole==='accountant');
    // Add expense form inputs disable/enable
    let inputs = document.querySelectorAll('#addExpenseForm input, #addExpenseForm select, #addExpenseForm button');
    inputs.forEach(i=> { 
      if(i.type!=='submit') i.disabled = !isEditable;
    });
    // Delete buttons visibility
    document.querySelectorAll('#expenseLogBody button.btn-danger').forEach(btn=>{
      btn.style.display = isEditable ? 'inline-block' : 'none';
    });
  }

  // Pie chart rendering
  let pieChartInstance=null;
  function renderPieChart(expList, rate){
    let ctx = document.getElementById('expensesPieChart').getContext('2d');
    if(pieChartInstance) pieChartInstance.destroy();
    let dataByCat = {};
    expenseCategories.forEach(c => dataByCat[c] = 0);
    expList.forEach(e => {
      if(e.category in dataByCat) dataByCat[e.category]+= e.amount * rate;
      else dataByCat['Other'] += e.amount * rate;
    });
    pieChartInstance = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: Object.keys(dataByCat),
        datasets: [{ data: Object.values(dataByCat),
          backgroundColor: ['#4a7c2c','#f4a259','#8b7355','#7fb069','#d9534f','#d0a85a','#739668','#a3c19c','#789262'] }]
      },
      options: { responsive:true, plugins:{ legend:{ position: 'bottom', labels: { color: getComputedStyle(document.body).color }}} }
    });
  }

  // Budget Bar chart rendering
  let budgetBarChartInstance=null;
  function renderBudgetBarChart(expList, rate){
    let ctx = document.getElementById('budgetBarChart').getContext('2d');
    if(budgetBarChartInstance) budgetBarChartInstance.destroy();
    let spentPerCat = {};
    expenseCategories.forEach(c => spentPerCat[c]=0);
    expList.forEach(e=>{
      spentPerCat[e.category] = (spentPerCat[e.category]||0) + e.amount * rate;
    });
    const budgetsScaled = expenseCategories.map(c => (budgetLimits[c]||0) * rate);
    const spentArray = expenseCategories.map(c => spentPerCat[c]||0);
  
    budgetBarChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: expenseCategories,
        datasets: [
          { label: 'Spent', data: spentArray, backgroundColor: '#4a7c2c' },
          { label: 'Budget', data: budgetsScaled, backgroundColor: '#f4a259' }
        ]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true }, x: { stacked: false } }
      }
    });
  }

  // Budget alert notifications
  function checkBudgetAlerts(expList, rate){
    let messages = [];
    expenseCategories.forEach(cat => {
      const spent = expList.filter(e=>e.category===cat).reduce((a,b)=>a+b.amount,0) * rate;
      const budget = (budgetLimits[cat]||0)*rate;
      if (budget > 0 && spent > budget*0.9) {
        messages.push(`Warning: Spending in "${cat}" reached ${Math.round(spent/budget*100)}% of budget.`);
      }
    });
    if(messages.length>0) showFinanceNotification(messages.join(' '));
    else hideFinanceNotification();
  }
  let notificationTimeout=null;
  function showFinanceNotification(msg){
    const notif = document.getElementById('financeNotification');
    notif.textContent = msg;
    notif.style.display = 'block';
    if(notificationTimeout) clearTimeout(notificationTimeout);
    notificationTimeout = setTimeout(() => {
      notif.style.display = 'none';
      notif.textContent = '';
    }, 8000);
  }
  function hideFinanceNotification(){
    const notif = document.getElementById('financeNotification');
    notif.style.display = 'none';
    notif.textContent = '';
  }

  // Exports
  function exportTableToCSV(filename, rows){
    const csv = rows.map(row => row.map(cell => `"${cell.toString().replace(/"/g, '""')}"`).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
  }
  document.getElementById('exportExpensesCSV').addEventListener('click', () => {
    const month = document.getElementById('monthFilter').value;
    let filtered = month ? expenses.filter(e=>e.date.startsWith(month)) : expenses;
    const rate = currencyRates[baseCurrency]||
